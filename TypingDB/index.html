<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <script src="js/jquery-3.4.1.min.js"></script> -->

    <link rel="stylesheet" href="css/style.css">
    <title>Typing</title>
</head>

<body>
    <p id="target">click to start</p>
    <p class="info">
        æ­£è§£ã®æ–‡å­—æ•°: <span id="score">0</span>
        ãƒŸã‚¹ã®æ–‡å­—æ•°: <span id="miss">0</span>
        æ®‹ã‚Šæ™‚é–“: <span id="timer">0.00</span>
    </p>
    <P id="dictionary">ã‚¿ã‚¤ãƒè¾å…¸<br></P>
    <!-- <script src="js/main.js"></script> -->

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- JQuery -->

    <!--** ä»¥ä¸‹Firebase **-->
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <!-- 6.6.1ã«è©²å½“ã™ã‚‹ç®‡æ‰€ã¯firebaseã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã™ã®ã§æ›´æ–°ã•ã‚Œã‚‹ãŸã³ã«éšæ™‚å¤‰ã‚ã‚Šã¾ã™ğŸ¤— -->
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
   https://firebase.google.com/docs/web/setup#config-web-app -->

    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyCIlzdyyxJGLID1GrK8uHP8_544iQnKDSo",
            authDomain: "dev20chat-f2691.firebaseapp.com",
            databaseURL: "https://dev20chat-f2691-default-rtdb.firebaseio.com/",
            projectId: "dev20chat-f2691",
            storageBucket: "dev20chat-f2691.appspot.com",
            messagingSenderId: "650956423214",
            appId: "1:650956423214:web:04e567e9ebcf9cf03f9fbf"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        //firebaseã®ãƒ‡ãƒ¼ã‚¿ãƒ¼ãƒ™ãƒ¼ã‚¹ï¼ˆä¿å­˜ã•ã›ã‚‹å ´æ‰€ï¼‰ã‚’ä½¿ã„ã¾ã™ã‚ˆ
        const newPostRef = firebase.database().ref();

        //å˜èª
        const words = ["apple", "banana", "lemon"];

        let word; //ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒ¯ãƒ¼ãƒ‰
        let loc; //æ–‡å­—ã®ä½ç½®
        let score; //æ­£è§£ã®æ–‡å­—æ•°
        let miss; //ãƒŸã‚¹ã®æ–‡å­—æ•°
        const timeLimit = 10 * 1000; //åˆ¶é™æ™‚é–“ ãƒŸãƒªç§’ã®ãŸã‚*1000
        let startTime; //é–‹å§‹æ™‚é–“
        let isPlaying = false; //ã‚²ãƒ¼ãƒ ä¸­ãƒ•ãƒ©ã‚°
        let missflag = false;

        const target = document.getElementById("target");
        const scoreLabel = document.getElementById("score");
        const missLabel = document.getElementById("miss");
        const timerLabel = document.getElementById("timer");
        let dictionary;

        // //ã‚¿ã‚¤ãƒã®æ–‡å­—è¡¨ç¤º
        // for (let i = 0; i < localStorage.length; i++) {
        //     var key = localStorage.key(i);
        //     dictionary = "<br>" + localStorage.getItem(key);
        //     $("#dictionary").append(dictionary);
        // }

        function updateTarget() {
            //æ–‡å­—æ•°ã®ã‚¢ãƒ³ãƒ€ãƒ¼ãƒãƒ¼è¡¨ç¤º
            let placeholder = "";
            for (let i = 0; i < loc; i++) {
                placeholder += "_";
            }
            //è¦ç¢ºèª
            target.textContent = placeholder + word.substring(loc);
        }

        function updateTimer() {
            //é–‹å§‹æ™‚é–“ã‚’è¨ˆç®—
            const timeLeft = startTime + timeLimit - Date.now();
            timerLabel.textContent = (timeLeft / 1000).toFixed(2);

            const timeoutId = setTimeout(() => {
                updateTimer();
            }, 10);

            //æ®‹ã‚Šæ™‚é–“ãŒç„¡ããªã£ãŸã‚‰çµ‚äº†
            if (timeLeft < 0) {
                isPlaying = false;
                clearTimeout(timeoutId);
                timerLabel.textContent = "0.00";
                target.textContent = "click to replay";
                // //ã‚¿ã‚¤ãƒã®æ–‡å­—è¡¨ç¤º
                // for (let i = 0; i < localStorage.length; i++) {
                //     var key = localStorage.key(i);
                //     dictionary = localStorage.getItem(key);
                //     $("#dictionary").append(dictionary);
                // }
            }
        }

        // çµæœè¡¨ç¤º
        function showResult() {
            alert("æ­£è§£ã®æ–‡å­—æ•°:${score},ãƒŸã‚¹ã®æ–‡å­—æ•°:${miss}");
        }

        //ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
        window.addEventListener("click", () => {
            //ãƒ—ãƒ¬ã‚¤ä¸­
            if (isPlaying === true) {
                return;
            }
            isPlaying = true;
            loc = 0;
            score = 0;
            miss = 0;
            scoreLabel.textContent = score;
            missLabel.textContent = miss;

            //ãƒ©ãƒ³ãƒ€ãƒ ã§å˜èªã‚’é¸æŠ
            word = words[Math.floor(Math.random() * words.length)];
            target.textContent = word;
            startTime = Date.now();
            updateTimer();
        });

        //ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®å…¥åŠ›å‡¦ç†
        window.addEventListener("keydown", (e) => {
            if (isPlaying !== true) {
                return;
            }
            //æ­£ã—ã„ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã®æ™‚
            if (e.key === word[loc]) {
                loc++;

                if (loc === word.length) {
                    if (missflag !== true) {
                        localStorage.removeItem(word);
                    } else {
                        missflag = false;
                    }
                    word = words[Math.floor(Math.random() * words.length)];
                    loc = 0;
                }
                updateTarget();
                score++;
                scoreLabel.textContent = score;
            } else {
                miss++;
                missflag = true;
                missLabel.textContent = miss;
                localStorage.setItem(word, word);

                newPostRef.push({
                    username: word,
                    text: word
                })
            }
        });

        // å—ä¿¡å‡¦ç†
        newPostRef.on("child_added", function (data) {
            let v = data.val();
            console.log(v);
            let k = data.key;

            let str = `<p>${v.text}<p>`;
            //htmlã«åŸ‹ã‚è¾¼ã‚€
            $("#dictionary").append(str);
        })

        window.addEventListener("keydown", (event) => {
            if (event.code === "Delete") {
                localStorage.clear();

            }
        });

    </script>

</body>

</html>